<main class="bg-slate-100 flex flex-col md:flex-row gap-2 w-full h-screen overflow-hidden items-center justify-center">
  <!--loading .... section-->
  <div *ngIf="isLoading" class="w-full flex h-full justify-center items-center bg-gradient-to-b from-primary to-blue-200">
    <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 24 24"><circle cx="12" cy="2" r="0" fill="#2979FF"><animate attributeName="r" begin="0" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(45 12 12)"><animate attributeName="r" begin="0.125s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(90 12 12)"><animate attributeName="r" begin="0.25s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(135 12 12)"><animate attributeName="r" begin="0.375s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(180 12 12)"><animate attributeName="r" begin="0.5s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(225 12 12)"><animate attributeName="r" begin="0.625s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(270 12 12)"><animate attributeName="r" begin="0.75s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle><circle cx="12" cy="2" r="0" fill="#2979FF" transform="rotate(315 12 12)"><animate attributeName="r" begin="0.875s" calcMode="spline" dur="1s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" repeatCount="indefinite" values="0;2;0;0"/></circle></svg>
  </div>

  <!--exam info-->
  <section *ngIf="mode === 'TEST' && !isLoading && !resourceNotFound && !examStarted"
    class="max-w-xl w-full text-center space-y-6 bg-white shadow-lg p-8 rounded-2xl">
    
    <!-- Title -->
    <h2 class="text-2xl md:text-3xl font-bold text-gray-800">
      {{ title }}
    </h2>

    <!-- Instruction -->
    <p class="text-gray-600 text-base md:text-lg">
      You're about to begin this exam. Please review the following details before starting.
    </p>

    <!-- Exam Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-left">
      <div class="bg-blue-50 rounded-lg p-4 shadow-sm">
        <p class="text-sm text-gray-500">Question Type</p>
        <p class="text-base font-medium text-gray-800">Multiple Choice</p>
      </div>

      <div class="bg-blue-50 rounded-lg p-4 shadow-sm">
        <p class="text-sm text-gray-500">Number of Questions</p>
        <p class="text-base font-medium text-gray-800">{{ examDto?.questions?.length }}</p>
      </div>

      <div class="bg-blue-50 rounded-lg p-4 shadow-sm">
        <p class="text-sm text-gray-500">Time Allotted</p>
        <p class="text-base font-medium text-gray-800">{{ examDto?.duration }} minutes</p>
      </div>
    </div>

    <!-- Optional: Start Button (if you want one later) -->
    
    <button (click)="startExam()"
        class="mt-6 bg-primary text-white px-6 py-3 rounded-lg hover:bg-btnHover transition">
      Start Exam
    </button>
   
  </section>
  
  <!-- Sidebar -->
  <aside *ngIf="examStarted" 
    class="overflow-y-auto w-full md:p-2 md:w-[10%] md:h-screen flex md:flex-col items-center justify-between md:justify-normal md:items-start rounded-lg">
    <!--question number list only on big screens-->
    <div class="hidden md:block p-1 w-full">
      <p class="text-lg text-gray-800 mb-4 whitespace-nowrap md:whitespace-normal overflow-auto">
        {{title}}
      </p>
      <div
        *ngFor="let question of questionList; let i = index"
        (click)="selectQuestion(i)"
        class="p-2 mb-1 w-full rounded-md cursor-pointer hover:text-blue-500"
        [class.text-blue-700]="i === currentQuestionIndex"
        [class.underline]="userAnswers.get(question.id ?? '')"
        [class.bg-green-400]="correctAnswers.get(question.id ?? '') === true && (mode === 'STUDY' || mode === 'TEST' && isSubmitted)"
        [class.bg-red-400]="correctAnswers.get(question.id ?? '') === false && (mode === 'STUDY' ||  mode === 'TEST' && isSubmitted)"
      >
        Question {{ question.questionNumber }}
      </div>
    </div>
    <!--question number list toggler on mobile view-->
    <section class="flex justify-between mt-2 items-center cursor-pointer md:hidden">
      <!--open drawer-->
      <div>
        <svg *ngIf="!showQuestionsDrawer" class="cursor-pointer mx-2"
          (click)="toggleQuestionsDrawer()"
          xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path fill="#000000" d="M3.75 5.25a.75.75 0 0 0 0 1.5h16.5a.75.75 0 0 0 0-1.5zm0 6a.75.75 0 0 0 0 1.5h16.5a.75.75 0 0 0 0-1.5zm0 6a.75.75 0 0 0 0 1.5h16.5a.75.75 0 0 0 0-1.5z"/>
        </svg>
      </div>
        <!--close drawer-->
      <div>
        <svg *ngIf="showQuestionsDrawer" class="cursor-pointer mx-2" [ngClass]="{'text-white': showQuestionsDrawer}"
            (click)="toggleQuestionsDrawer()"
            xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path fill="#1a4fa3" d="m6.4 18.308l-.708-.708l5.6-5.6l-5.6-5.6l.708-.708l5.6 5.6l5.6-5.6l.708.708l-5.6 5.6l5.6 5.6l-.708.708l-5.6-5.6z"/>
        </svg>
      </div>
      <!--drawer-->
      <div *ngIf="showQuestionsDrawer" class="z-50" >
         <app-question-list-drawer
            [questionList]="questionList"
            [currentQuestionIndex]="currentQuestionIndex"
            [correctAnswers]="correctAnswers"
            [mode]="this.mode"
            [isSubmitted]="this.isSubmitted"
            (onQuestionSelect)="selectQuestion($event)"
         >
         </app-question-list-drawer>
      </div>
      <!--title to be shown on mobile view only-->
      <p class="text-sm text-gray-800">{{title}}</p>
    </section>
  </aside>

  <!-- Main Content -->
  <main *ngIf="examStarted" class="h-full w-full md:w-[90%] md:p-2 rounded-lg overflow-hidden">
    <div class="flex justify-between items-center p-2">
      <h2 class="flex gap-1 text-sm md:text-lg text-gray-800">
        <span class="hidden md:block">Question</span> {{ questionList.length !== 0 ? currentQuestionIndex + 1 : 0 }} of {{ questionList.length }}
      </h2>
      <!--time counter-->
      <div *ngIf="mode === 'TEST'" class="flex gap-1 md:text-lg">
        <span class="hidden md:block">Time Remaining</span> {{ formatTime(timer) }}
      </div>
      <!--score , submit , retak button-->
      <div class="flex justify-center items-center gap-3 md:gap-6">
        <button
            *ngIf="mode === 'TEST' && !isSubmitted && timer > 0 && userAnswers.size > 0"
            (click)="submitExam()"
            class="py-1 px-3 md:px-4 text-primary hover:text-blue-400 border-1 border-gray-400 rounded-lg transition-colors cursor-pointer"
          >
            Submit
        </button>
        <button
          *ngIf="mode === 'STUDY' && userAnswers.size === questionList.length"
          (click)="submitExam()"
          class="py-1 px-3 md:px-4 text-primary hover:text-blue-400 border-1 border-gray-400 rounded-lg transition-colors cursor-pointer"
        >
          Score
        </button>
        <button
          *ngIf="(mode === 'STUDY' && userAnswers.size === questionList.length) || (mode === 'TEST' && isSubmitted)"
          (click)="retakeExam()"
          class="py-1 px-3 md:px-4 text-primary hover:text-blue-400 border-1 border-gray-400 rounded-lg transition-colors cursor-pointer"
        >
          Retake
        </button>
      </div>
      <!--save and exit -->
      <div *ngIf="mode === 'TEST' && hasFullAccess && isAuthenticated && this.userAnswers.size > 0 && !isSubmitted" 
          class="flex justify-center">
        <button 
          (click)="saveAndExit()"  
          class="py-1 px-3 md:px-4 text-gray-500 hover:text-blue-400 border-1 border-gray-400 rounded-lg transition-colors cursor-pointer"
        >
          Save and Exit
        </button>
      </div>
      <!--close button-->
      <button class="p-1 bg-gray-100 cursor-pointer" (click)="close()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/>
        </svg>
      </button>
    </div>
    <!--no question available section-->
    <div *ngIf="questionList.length === 0" class="h-64 flex items-center justify-center text-gray-800 text-lg">
      No questions available for this exam.
    </div>
    <!--question display section-->
    <section #questionContainer *ngIf="questionList.length > 0"
       class="h-full bg-gray-100 text-gray-900 p-2 md:p-4 rounded-md border border-gray-200 overflow-y-scroll overflow-x-hidden">
      <!--qustion text -->
      <div class="flex flex-col md:flex-row items-start mb-4 md:gap-1">
        <span>{{ currentQuestion.questionNumber }}.</span>
        <!-- <div class="break-words whitespace-normal border-2 border-gray-200 overflow-hidden px-3 w-full max-w-90%" 
          [innerHTML]="currentQuestion.questionText"
          (click)="handleLinkClick($event)"
        ></div> -->
        <div [appFirefoxQuillViewPatch]="currentQuestion.questionText" 
            class="w-full max-w-[90%]">
          <quill-view 
            [content]="currentQuestion.questionText"
            format="html"
            theme="snow"
            [sanitize]="true"
            (click)="handleLinkClick($event)"
            class="w-full"
            >
          </quill-view>
        </div>
      </div>
      <!--choices-->
      <div class="space-y-2 mb-4">
        <div *ngFor="let choice of currentQuestion.choices; let i = index;" 
          class="flex items-start space-x-2">
          <div class="flex items-center py-2">
            <span class="w-6 font-bold">{{ getChoiceLetter(i) }}.</span>
            <input
              type="radio"
              [name]="'question_' + currentQuestionIndex"
              (change)="selectAnswer(choice.id)"
              [checked]="userAnswers.get(currentQuestion.id ?? '') === choice.id"
              [disabled]="mode === 'STUDY' && userAnswers.has(currentQuestion.id ?? '')"
              [disabled]="mode === 'TEST' && isSubmitted"
              class="h-4 w-4 cursor-pointer"
              style="accent-color: #86efac"
            />
          </div>
          <div class="flex gap-2 w-full max-w-90% items-center">
            <!--choice text-->
            <!-- <span
              class="break-words whitespace-normal overflow-hidden py-2 px-3"
              [ngClass]="[
                (mode === 'STUDY' && choice.isCorrect && userAnswers.has(currentQuestion.id ?? '')) 
                    ? 'border-2 rounded-md border-green-300 p-1 ' : '' ,
                (mode === 'TEST' && isSubmitted && choice.isCorrect) 
                    ? 'border-2 rounded-md border-green-300 p-1' : ''
              ]"
              [innerHTML]="choice.text"
              (click)="handleLinkClick($event)"
            ></span> -->
            <span class="w-full"
               [ngClass]="[
                (mode === 'STUDY' && choice.isCorrect && userAnswers.has(currentQuestion.id ?? '')) 
                    ? 'border-2 rounded-md border-green-300 p-1 ' : '' ,
                (mode === 'TEST' && isSubmitted && choice.isCorrect) 
                    ? 'border-2 rounded-md border-green-300 p-1' : ''
              ]">
              <span [appFirefoxQuillViewPatch]="choice.text" class="w-[90%]">
                <quill-view 
                  class="w-full"
                  [content]="choice.text"
                  format="html"
                  theme="snow"
                  [sanitize]="true"
                  (click)="handleLinkClick($event)"
                >
                </quill-view>
              </span>
            </span>
            <span *ngIf="choice.percentage !== null &&
                (mode === 'STUDY' && userAnswers.has(currentQuestion.id ?? '') || mode === 'TEST' && isSubmitted)"
                class="text-gray-500 p-1 text-xs bg-gray-100 rounded-lg">
              {{choice.percentage}}% ( {{currentQuestion.totalResponses}} )
            </span>
          </div>
        </div>
      </div>

      <!--explanation-->
      <div class="mt-4" *ngIf="(userAnswers.has(currentQuestion.id ?? '') &&  mode === 'STUDY') || (mode === 'TEST' && isSubmitted)">
        <p (click)="showExplanation = !showExplanation" class="text-primary cursor-pointer hover:text-btnHover">
          {{ showExplanation ? 'Hide' : 'Show' }} Explanation
        </p>
        <!--explanation text-->
        <div *ngIf="showExplanation" 
          class="mt-2 p-4 bg-gray-200 rounded-md border border-gray-200">
          <div [appFirefoxQuillViewPatch]="currentQuestion.explanation">
            <quill-view 
              [content]="currentQuestion.explanation"
              format="html"
              theme="snow"
              [sanitize]="true"
              (click)="handleLinkClick($event)"
            >
            </quill-view>
          </div>
          <!-- <div class="break-words whitespace-normal overflow-hidden py-2 px-3 w-full max-w-90%" 
            [innerHTML]="currentQuestion.explanation"
            (click)="handleLinkClick($event)"
          ></div> -->
        </div>
      </div>
      <div class="flex flex-col justify-center items-center gap-2 mb-16 mt-4">
        <div class="flex justify-center gap-10">
          <button
            (click)="previousQuestion()"
            [disabled]="currentQuestionIndex === 0"
            class="py-1 px-3 md:px-4 text-gray-500 border-1 border-gray-400 rounded-lg disabled:text-gray-600 disabled:cursor-not-allowed cursor-pointer"
          >
            Previous
          </button>
          <button
            (click)="nextQuestion()"
            [disabled]="currentQuestionIndex === questionList.length - 1"
            class="py-1 px-3 md:px-4 text-gray-500 border-1 border-gray-400 rounded-lg disabled:text-gray-600 disabled:cursor-not-allowed cursor-pointer"
          >
            Next
          </button>
        </div>
      </div>
    </section>
  </main>
  <!-- Resource Not Found -->
  <div *ngIf="resourceNotFound" class="flex flex-col items-center gap-2">
    <p>No resouce available</p>
    <p (click)="close()" class="text-blue-500 cursor-pointer">close</p>
  </div>
</main>
